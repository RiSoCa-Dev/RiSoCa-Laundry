/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for user data and a role-based access model
 * for global data like orders. User-specific data is nested, ensuring privacy, while a global `orders` collection
 * allows admins to manage all orders.
 *
 * Data Structure:
 * - /users/{userId}: A collection storing individual UserProfile documents.
 *   - /addresses/{addressId}: Subcollection for a user's addresses.
 *   - /notifications/{notificationId}: Subcollection for a user's notifications.
 * - /orders/{orderId}: A top-level collection for all laundry orders. Admins have full access. Users can create
 *   orders and read/update their own.
 * - /services/{serviceId}: A top-level collection for public service information.
 * - /service_rates/{rateId}: A top-level collection for service pricing. Admins have full access.
 *
 * Key Security Decisions:
 * - User Data Privacy: Data under `/users/{userId}` is private to the owning user.
 * - Admin Role: An `admin` role is defined in the user's profile. This role grants broader permissions,
 *   specifically for managing the global `/orders` and `/service_rates` collections.
 * - Centralized Orders: All orders are stored in a single `/orders` collection. Security rules ensure users
 *   can only see their own orders, while admins can see all of them. This simplifies admin-related queries.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }
    
    function isNewUserProfile(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }
    
    function isImmutableUserId() {
      return request.resource.data.id == resource.data.id;
    }
    
    function isNewOwnedDocument(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }
    
    function isImmutableOwnerLink() {
      return request.resource.data.userId == resource.data.userId;
    }
    
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    //-------------------------------------------------------------------------
    // User Data
    //-------------------------------------------------------------------------
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isNewUserProfile(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserId();
      allow delete: if isOwner(userId) || isAdmin();

      match /addresses/{addressId} {
        allow get, list, create, update, delete: if isOwner(userId);
      }

      match /notifications/{notificationId} {
        allow get, list, create, update, delete: if isOwner(userId);
      }
    }
    
    //-------------------------------------------------------------------------
    // Global Data
    //-------------------------------------------------------------------------
    
    match /orders/{orderId} {
        allow get: if isOwner(resource.data.userId) || isAdmin();
        allow list: if isAdmin(); // Admins can list all orders. Users query with 'where' clause, enforced by client logic.
        allow create: if isNewOwnedDocument(request.auth.uid);
        allow update: if isAdmin(); // Only admins can update order status, weight, etc.
        allow delete: if isAdmin();
    }

    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    match /service_rates/{rateId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
